<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AAU Robot Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Grid: 3 rows (25%,25%,50%) x 2 columns */
    #dashboard {
      display: grid;
      grid-template-rows: 25% 25% 50%;
      grid-template-columns: 50% 50%;
      width: 100vw;
      height: 100vh;
      min-width: 1920px;
      min-height: 1080px;
      box-sizing: border-box;
      overflow: hidden;
    }
    .panel {
      border: 1px solid #444;
      background: #2a2a2a;
      position: relative;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      padding: 8px;
    }
    .panel-title {
      position: absolute;
      top: 8px;
      left: 8px;
      font-weight: bold;
      color: #fff;
      z-index: 1;
    }
    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #sideVideo {
      width: auto;
      height: 100%;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    .neon-btn {
      background-color: #222;
      color: #4af;
      border: 1px solid #4af;
      transition: all 0.2s ease-in-out;
    }
    .neon-btn:hover {
      background-color: #4af;
      color: #111;
      box-shadow: 0 0 8px #4af;
    }
    .console-area {
      background: #111;
      border: 1px solid #4af;
      font-family: monospace;
      padding: 4px;
      overflow-y: auto;
      flex: 1;
    }
    select {
      background-color: #2a2a2a;
      color: #4af;
      border: 1px solid #4af;
      padding: 4px;
    }
  </style>
</head>
<body class="bg-gray-900 text-green-300">
<div id="dashboard">
  <!-- Row1, Col1: Side Camera -->
  <div class="panel" style="grid-row:1; grid-column:1;">
    <div class="panel-title">Side Camera (Window1)</div>
    <video id="sideVideo" autoplay muted playsinline></video>
  </div>
  <!-- Row1, Col2: Model Selection -->
  <div class="panel" style="grid-row:1; grid-column:2; justify-content: center; align-items: center;">
    <div class="panel-title">Model Selection (Window5)</div>
    <div style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem;">
      <div>
        <label for="vlmSelect" style="margin-right: 8px;">VLM:</label>
        <select id="vlmSelect">
          {% for opt in vlm_options %}
          <option value="{{ opt }}">{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="llmSelect" style="margin-right: 8px;">LLM:</label>
        <select id="llmSelect">
          {% for opt in llm_options %}
          <option value="{{ opt }}">{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
  <!-- Row2, Col1: Top Cameras (Seg & Depth Preview) -->
  <div class="panel" style="grid-row:2; grid-column:1; flex-direction: row; padding: 0;">
    <!-- Top Camera Segmentation -->
    <div style="flex:1; position: relative; border-right: 1px solid #333; display: flex; align-items: center; justify-content: center;">
      <div class="panel-title">Top Camera (Window2) - Seg</div>
      <img id="topSegImg" src="https://via.placeholder.com/320x180?text=Seg+Camera" alt="TopSeg">
      <select id="topSegMode" class="absolute" style="top:8px; right:8px;">
        <option value="off">Off</option>
        <option value="seg">Seg</option>
      </select>
    </div>
    <!-- Depth Preview -->
    <div style="flex:1; position: relative; display: flex; align-items: center; justify-content: center;">
      <div class="panel-title">Depth Camera (Window3)</div>
      <img id="topDepthImg" src="https://via.placeholder.com/320x180?text=Depth+Camera" alt="DepthCam">
      <select id="topDepthMode" class="absolute" style="top:8px; right:8px;">
        <option value="off">Off</option>
        <option value="default_anything">Default Camera + DepthAnything</option>
        <option value="local_depth_anything">Local Camera + DepthAnything</option>
        <option value="realsense_rgb_anything">RealSense RGB + DepthAnything</option>
        <option value="realsense_depth">RealSense Depth</option>
        <option value="other">Other Depth</option>
      </select>
    </div>
  </div>
  <!-- Row2, Col2: Robot Control -->
  <div class="panel" style="grid-row:2; grid-column:2; justify-content: center; align-items: center;">
    <div class="panel-title">Robot Control (Window6)</div>
    <div style="margin-top: 2rem; display: flex; flex-direction: row; gap: 1rem;">
      <button class="neon-btn px-3 py-1" onclick="sendChat('move forward')">Forward</button>
      <button class="neon-btn px-3 py-1" onclick="sendChat('2 to the left')">Left x2</button>
      <button class="neon-btn px-3 py-1" onclick="sendChat('turn right')">Right</button>
    </div>
  </div>
  <!-- Row3, Col1: Chat -->
  <div class="panel" style="grid-row:3; grid-column:1;">
    <div class="panel-title">Chat (Window4)</div>
    <div id="chatMessages" style="flex:1; overflow-y:auto; background:#111; border:1px solid #666; padding:4px; margin-top:30px;"></div>
    <div style="display:flex; margin-top:8px;">
      <input type="text" id="chatInput" class="bg-gray-800 text-green-300 border border-green-500 px-2 py-1 flex-1" placeholder="Type command...">
      <button id="sendChatBtn" class="neon-btn px-3 py-1" style="margin-left:8px;">Send</button>
    </div>
  </div>
  <!-- Row3, Col2: LLM Reasoning Console -->
  <div class="panel" style="grid-row:3; grid-column:2; display:flex; flex-direction:column;">
    <div class="panel-title">LLM Reasoning (Window7)</div>
    <div id="llmConsole" class="console-area" style="margin-top:30px;"></div>
  </div>
</div>

<script>
/****************************************************
 * 0) On page load: fetch camera info and adjust dropdown.
 ****************************************************/
window.addEventListener("DOMContentLoaded", async () => {
  try {
    const resp = await fetch("/camera_info");
    if (!resp.ok) throw new Error("camera_info error: " + resp.status);
    const data = await resp.json();
    console.log("[camera_info]", data);
    if (!data.realsense_available) {
      const depthModeSelect = document.getElementById("topDepthMode");
      for (let i = depthModeSelect.options.length - 1; i >= 0; i--) {
        const val = depthModeSelect.options[i].value;
        if (val.includes("realsense")) {
          depthModeSelect.remove(i);
        }
      }
    }
  } catch (err) {
    console.warn("Could not fetch camera_info:", err);
  }
});

/****************************************************
 * 1) Side Camera Stream from Browser
 ****************************************************/
let localStream = null;
const sideVideo = document.getElementById("sideVideo");
(async function(){
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: { width: 1280, height: 720, frameRate: 20 },
      audio: false
    });
    sideVideo.srcObject = localStream;
  } catch(err){
    console.error("Camera error:", err);
  }
})();

function captureSideFrame(){
  return new Promise((resolve, reject) => {
    try {
      const canvas = document.createElement("canvas");
      canvas.width = sideVideo.videoWidth;
      canvas.height = sideVideo.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(sideVideo, 0, 0, canvas.width, canvas.height);
      const b64 = canvas.toDataURL("image/jpeg").split(",")[1];
      resolve(b64);
    } catch (e) {
      reject(e);
    }
  });
}

/****************************************************
 * 2) Segmentation (unchanged)
 ****************************************************/
let segLoop = false;
document.getElementById("topSegMode").addEventListener("change", function(){
  segLoop = (this.value === "seg");
  if (segLoop) runSegLoop();
});
async function runSegLoop(){
  if (!segLoop) return;
  try {
    const b64 = await captureSideFrame();
    const resp = await fetch("/process_seg", {
      method:"POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ frame: b64 })
    });
    if (!resp.ok) throw new Error("Seg error:" + resp.status);
    const data = await resp.json();
    document.getElementById("topSegImg").src = "data:image/jpeg;base64," + data.frame;
  } catch(err){
    console.error(err);
  }
  if (segLoop) setTimeout(runSegLoop, 500);
}
document.getElementById("topSegImg").addEventListener("click", function(ev){
  if (!segLoop) return;
  const rect = this.getBoundingClientRect();
  const nx = (ev.clientX - rect.left) / rect.width;
  const ny = (ev.clientY - rect.top) / rect.height;
  captureSideFrame().then(async b64 => {
    const r = await fetch("/process_seg", {
      method:"POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ frame: b64, clicked_x: nx, clicked_y: ny })
    });
    if (!r.ok) throw new Error("Seg click error");
    const d = await r.json();
    document.getElementById("topSegImg").src = "data:image/jpeg;base64," + d.frame;
  }).catch(err => console.error(err));
});

/****************************************************
 * 3) Depth Handling: Polling /process_depth
 ****************************************************/
let depthLoop = false;
document.getElementById("topDepthMode").addEventListener("change", function(){
  if (this.value === "off"){
    depthLoop = false;
    fetch("/process_depth", {
      method:"POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ camera_mode: "off" })
    });
  } else {
    depthLoop = true;
    runDepthLoop();
  }
});
async function runDepthLoop(){
  if (!depthLoop) return;
  try {
    const modeVal = document.getElementById("topDepthMode").value;
    let b64 = "";
    if (modeVal === "default_anything" || modeVal === "other"){
      b64 = await captureSideFrame();
    }
    const resp = await fetch("/process_depth", {
      method:"POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ camera_mode: modeVal, local_idx: 0, frame: b64 })
    });
    if (!resp.ok) throw new Error("Depth error:" + resp.status);
    const data = await resp.json();
    if (data.error) console.log("[Depth] error =>", data.error);
    if (data.frame) {
      document.getElementById("topDepthImg").src = "data:image/jpeg;base64," + data.frame;
    }
  } catch(err) {
    console.error("Depth error:", err);
  }
  if (depthLoop) setTimeout(runDepthLoop, 500);
}

/****************************************************
 * 4) Chat Functionality
 ****************************************************/
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const chatSendBtn = document.getElementById("sendChatBtn");
chatSendBtn.addEventListener("click", () => sendChat());
chatInput.addEventListener("keyup", (e) => {
  if(e.key === "Enter") sendChat();
});
function addChatMessage(sender, msg) {
  if (chatMessages.children.length >= 1000)
    chatMessages.removeChild(chatMessages.firstChild);
  const div = document.createElement("div");
  div.innerHTML = `<strong>${sender}:</strong> ${msg}`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
async function sendChat(customText){
  let userText = customText || chatInput.value.trim();
  if(!userText) return;
  chatInput.value = "";
  addChatMessage("You", userText);
  try {
    const resp = await fetch("/chat", {
      method:"POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ text: userText })
    });
    if (!resp.ok) throw new Error("Chat fail:" + resp.status);
    const data = await resp.json();
    addChatMessage("AAU Agent", data.reply);
  } catch(err){
    console.error(err);
    addChatMessage("AAU Agent", "Error:" + err.toString());
  }
}

/****************************************************
 * 5) LLM Reasoning Console
 ****************************************************/
const llmConsole = document.getElementById("llmConsole");
function logToConsole(msg) {
  if(llmConsole.children.length >= 1000)
    llmConsole.removeChild(llmConsole.firstChild);
  const d = document.createElement("div");
  d.textContent = msg;
  llmConsole.appendChild(d);
  llmConsole.scrollTop = llmConsole.scrollHeight;
}
</script>
</body>
</html>
